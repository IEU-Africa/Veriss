<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Verifying Payment - Veriss Payments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="assets/css/app.css" />
    <style>
      body {
        background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: system-ui, -apple-system, sans-serif;
      }

      .verification-card {
        background: white;
        border-radius: 1rem;
        padding: 3rem;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        text-align: center;
      }

      .spinner {
        border: 4px solid #e5e7eb;
        border-top: 4px solid #16a34a;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1.5rem;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      .success-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: #dcfce7;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
      }

      .success-icon svg {
        width: 48px;
        height: 48px;
        color: #16a34a;
      }

      .error-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: #fee2e2;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
      }

      .error-icon svg {
        width: 48px;
        height: 48px;
        color: #dc2626;
      }

      .btn {
        padding: 0.75rem 2rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
        margin-top: 1.5rem;
      }

      .btn-primary {
        background: #16a34a;
        color: white;
      }

      .btn-primary:hover {
        background: #15803d;
      }

      .btn-secondary {
        background: #e5e7eb;
        color: #374151;
      }

      .btn-secondary:hover {
        background: #d1d5db;
      }

      .payment-details {
        background: #f9fafb;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-top: 1.5rem;
        text-align: left;
      }

      .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid #e5e7eb;
      }

      .detail-row:last-child {
        border-bottom: none;
      }

      .detail-label {
        color: #6b7280;
        font-size: 0.875rem;
      }

      .detail-value {
        color: #111827;
        font-weight: 600;
        font-size: 0.875rem;
      }
    </style>
  </head>

  <body>
    <div class="verification-card" id="verificationCard">
      <!-- Loading State -->
      <div id="loadingState">
        <div class="spinner"></div>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Verifying Payment</h2>
        <p class="text-gray-600">Please wait while we confirm your payment...</p>
      </div>

      <!-- Success State -->
      <div id="successState" style="display: none;">
        <div class="success-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-green-700 mb-2">Payment Successful!</h2>
        <p class="text-gray-600 mb-4" id="successMessage">Your payment has been processed successfully.</p>

        <div class="payment-details" id="paymentDetails" style="display: none;">
          <h3 class="font-semibold text-gray-900 mb-3">Payment Details</h3>
          <div class="detail-row">
            <span class="detail-label">Reference:</span>
            <span class="detail-value" id="paymentReference">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Amount:</span>
            <span class="detail-value" id="paymentAmount">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Service:</span>
            <span class="detail-value" id="serviceName">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Date:</span>
            <span class="detail-value" id="paymentDate">-</span>
          </div>
        </div>

        <a href="dashboard.html" class="btn btn-primary">Go to Dashboard</a>
      </div>

      <!-- Error State -->
      <div id="errorState" style="display: none;">
        <div class="error-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-red-700 mb-2">Payment Verification Failed</h2>
        <p class="text-gray-600 mb-4" id="errorMessage">We couldn't verify your payment. Please contact support.</p>

        <div class="flex gap-3 justify-center">
          <a href="dashboard.html" class="btn btn-secondary">Go to Dashboard</a>
          <a href="mailto:support@veriss.com" class="btn btn-primary">Contact Support</a>
        </div>
      </div>

      <!-- No Reference State -->
      <div id="noReferenceState" style="display: none;">
        <div class="error-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Invalid Request</h2>
        <p class="text-gray-600 mb-4">No payment reference found in the URL.</p>

        <a href="dashboard.html" class="btn btn-primary">Go to Dashboard</a>
      </div>
    </div>

    <script type="module">
      import { verifyPaymentApi } from "./assets/js/services/member/controller.js";
      import { getCookie } from "./assets/js/utils/cookies.js";

      const loadingState = document.getElementById('loadingState');
      const successState = document.getElementById('successState');
      const errorState = document.getElementById('errorState');
      const noReferenceState = document.getElementById('noReferenceState');

      function showState(state) {
        loadingState.style.display = 'none';
        successState.style.display = 'none';
        errorState.style.display = 'none';
        noReferenceState.style.display = 'none';

        document.getElementById(state).style.display = 'block';
      }

      function formatCurrency(amount) {
        return 'â‚¦' + (amount || 0).toLocaleString();
      }

      function formatDate(date) {
        if (!date) return 'N/A';
        return new Date(date).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      async function verifyPayment() {
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const reference = urlParams.get('reference') || urlParams.get('trxref');

        // Check if reference exists
        if (!reference) {
          showState('noReferenceState');
          return;
        }

        // Get auth token
        const token = getCookie('auth_token');
        console.log('Auth Token:', token);
        if (!token) {
          // Redirect to login if no token
          window.location.href = 'login.html';
          return;
        }

        try {
          // Call verification API
          const response = await verifyPaymentApi({ trxref: reference }, token);

          if (response.success) {

            // Show success state
            showState('successState');

            // Update success message if available
            if (response.message) {
              document.getElementById('successMessage').textContent = response.message;
            }

            // Display payment reference if available
            if (reference) {
              document.getElementById('paymentDetails').style.display = 'block';
              document.getElementById('paymentReference').textContent = reference;
              // Hide other details since they're not provided by the API
              document.getElementById('paymentAmount').textContent = 'N/A';
              document.getElementById('serviceName').textContent = 'N/A';
              document.getElementById('paymentDate').textContent = formatDate(new Date());
            }

            // Redirect to dashboard after 5 seconds
            setTimeout(() => {
              window.location.href = 'user-dashboard.html';
            }, 5000);
          } else {
            // Verification failed
            showState('errorState');
            document.getElementById('errorMessage').textContent =
              response.message || 'Payment verification failed. Please contact support with your reference number: ' + reference;
          }
        } catch (error) {
          console.error('Verification error:', error);
          showState('errorState');
          document.getElementById('errorMessage').textContent =
            error.message || 'An error occurred while verifying your payment. Please contact support.';
        }
      }

      // Start verification when page loads
      verifyPayment();
    </script>
  </body>

</html>