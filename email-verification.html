<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Verification - Veriss Payments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
      /* CSS Custom Properties for Veriss Payments Brand Colors */
      :root {
        --primary-50: #f0f9ff;
        --primary-100: #e0f2fe;
        --primary-200: #bae6fd;
        --primary-300: #7dd3fc;
        --primary-400: #38bdf8;
        --primary-500: #0ea5e9;
        --primary-600: #0284c7;
        --primary-700: #0369a1;
        --primary-800: #075985;
        --primary-900: #0c4a6e;

        --success-50: #f0fdf4;
        --success-100: #dcfce7;
        --success-200: #bbf7d0;
        --success-300: #86efac;
        --success-400: #4ade80;
        --success-500: #22c55e;
        --success-600: #16a34a;
        --success-700: #15803d;
        --success-800: #166534;
        --success-900: #14532d;

        --neutral-50: #fafafa;
        --neutral-100: #f5f5f5;
        --neutral-200: #e5e5e5;
        --neutral-300: #d4d4d4;
        --neutral-400: #a3a3a3;
        --neutral-500: #737373;
        --neutral-600: #525252;
        --neutral-700: #404040;
        --neutral-800: #262626;
        --neutral-900: #171717;
      }

      /* Custom styles for modern UI */
      .modern-card {
        background: white;
        border-radius: 1.5rem;
        padding: 2.5rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      .modern-input {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid var(--neutral-200);
        border-radius: 0.75rem;
        font-size: 1rem;
        transition: all 0.2s;
        background: white;
      }

      .modern-input:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-weight: 600;
        border-radius: 0.75rem;
        transition: all 0.2s;
        cursor: pointer;
        border: none;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
        color: white;
        padding: 1rem 1.5rem;
      }

      .btn-primary:hover:not(:disabled) {
        background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
        transform: translateY(-2px);
      }

      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: white;
        color: var(--primary-600);
        border: 2px solid var(--primary-200);
        padding: 0.75rem 1.5rem;
      }

      .btn-secondary:hover:not(:disabled) {
        background: var(--primary-50);
        border-color: var(--primary-300);
      }

      .modern-link {
        color: var(--primary-600);
        text-decoration: none;
        transition: color 0.2s;
      }

      .modern-link:hover {
        color: var(--primary-700);
        text-decoration: underline;
      }

      /* Code input styling */
      .code-input {
        width: 3.5rem;
        height: 3.5rem;
        text-align: center;
        font-size: 1.5rem;
        font-weight: 700;
        border: 2px solid var(--neutral-200);
        border-radius: 0.75rem;
        transition: all 0.2s;
      }

      .code-input:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
      }

      /* Custom SweetAlert2 styling */
      .swal2-popup {
        border-radius: 1rem !important;
        padding: 2rem !important;
      }

      .swal2-confirm {
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%) !important;
        border-radius: 0.5rem !important;
      }
    </style>
  </head>

  <body class="bg-gradient-to-br from-neutral-50 to-neutral-100">
    <div id="app" class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
      <div class="max-w-md w-full">
        <!-- Back to Login Link -->
        <div class="text-center mb-6">
          <a href="login.html" class="inline-flex items-center gap-2 font-semibold transition-all hover:scale-105"
            style="color: var(--primary-600);">
            <i data-lucide="arrow-left" class="w-4 h-4"></i>
            Back to Login
          </a>
        </div>

        <div class="modern-card shadow-2xl">
          <!-- Header Section -->
          <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl shadow-lg mb-4"
              style="background: linear-gradient(to bottom right, var(--primary-100), var(--primary-200)); color: var(--primary-600);">
              <i data-lucide="mail-check" class="w-10 h-10"></i>
            </div>
            <h2 class="text-3xl font-extrabold mb-2" style="color: var(--neutral-900);">Verify Your Email</h2>
            <p class="font-medium" style="color: var(--neutral-600);">
              We've sent a verification code to<br>
              <strong style="color: var(--neutral-900);">{{ userEmail }}</strong>
            </p>
          </div>

          <!-- Verification Form -->
          <form class="space-y-6" @submit.prevent="handleVerify">

            <!-- Code Input Fields -->
            <div>
              <label class="block text-sm font-bold mb-3 text-center" style="color: var(--neutral-700);">
                Enter 6-Digit Code
              </label>
              <div class="flex justify-center gap-2">
                <input v-for="(digit, index) in code" :key="index" v-model="code[index]" type="text" maxlength="1"
                  class="code-input" :ref="el => codeInputs[index] = el" @input="handleInput(index, $event)"
                  @keydown="handleKeydown(index, $event)" @paste="handlePaste($event)" pattern="[0-9]"
                  inputmode="numeric">
              </div>
            </div>

            <!-- Timer and Resend -->
            <div class="text-center">
              <p v-if="timer > 0" class="text-sm" style="color: var(--neutral-500);">
                Didn't receive the code? Resend in <strong style="color: var(--primary-600);">{{ timer }}s</strong>
              </p>
              <button v-else type="button" @click="resendCode" :disabled="isResending"
                class="text-sm font-semibold modern-link">
                {{ isResending ? 'Sending...' : 'Resend Code' }}
              </button>
            </div>

            <!-- Submit Button -->
            <div>
              <button type="submit" :disabled="!isCodeComplete || isVerifying"
                class="btn btn-primary w-full text-base py-4 shadow-xl">
                <i data-lucide="check-circle" class="w-5 h-5"></i>
                <span v-if="!isVerifying">Verify Email</span>
                <span v-else>Verifying...</span>
              </button>
            </div>

            <!-- Help Text -->
            <div class="text-center pt-4" style="border-top: 1px solid var(--neutral-200);">
              <p class="text-sm" style="color: var(--neutral-500);">
                Check your spam folder if you don't see the email
              </p>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script type="module">
      import Swal from 'https://cdn.jsdelivr.net/npm/sweetalert2@11.26.17/+esm';
      import { sendVerificationCodeApi, verifyEmailCodeApi } from './assets/js/services/organisation/auth.js';

      import { sendVerificationCodeApiMember, verifyEmailCodeApiMember } from './assets/js/services/member/auth.js';

      import { showErrorAlert, showSuccessAlert } from './assets/js/utils/alerts.js';

      const { createApp } = Vue;

      createApp({
        data() {
          return {
            userEmail:'', // This should come from registration or URL params
            code: ['', '', '', '', '', ''],
            codeInputs: [],
            timer: 60,
            timerInterval: null,
            isVerifying: false,
            isResending: false,
            accountType: '' // 'organisation' or 'member'
          }
        },

        computed: {
          isCodeComplete() {
            return this.code.every(digit => digit !== '');
          },

          fullCode() {
            return this.code.join('');
          }
        },

        mounted() {
          lucide.createIcons();

          // get email from URL params
          const emailParam = new URLSearchParams(window.location.search).get('email').trim();
          this.userEmail = emailParam || '';
          this.accountType = new URLSearchParams(window.location.search).get('type').trim() || '';

          // Send initial code on mount
          this.sendCode();
          this.startTimer();

          // Focus first input
          if (this.codeInputs[0]) {
            this.codeInputs[0].focus();
          }
        },

        updated() {
          lucide.createIcons();
        },

        beforeUnmount() {
          if (this.timerInterval) {
            clearInterval(this.timerInterval);
          }
        },

        methods: {
          /**
           * Start countdown timer for resend functionality
           */
          startTimer() {
            this.timer = 60;
            if (this.timerInterval) {
              clearInterval(this.timerInterval);
            }
            this.timerInterval = setInterval(() => {
              if (this.timer > 0) {
                this.timer--;
              } else {
                clearInterval(this.timerInterval);
              }
            }, 1000);
          },

          /**
           * Handle input in code fields - auto-advance to next field
           */
          handleInput(index, event) {
            const value = event.target.value;

            // Only allow numbers
            if (value && !/^\d$/.test(value)) {
              this.code[index] = '';
              return;
            }

            // Auto-advance to next input
            if (value && index < 5) {
              this.$nextTick(() => {
                if (this.codeInputs[index + 1]) {
                  this.codeInputs[index + 1].focus();
                }
              });
            }
          },

          /**
           * Handle keyboard navigation between code inputs
           */
          handleKeydown(index, event) {
            // Backspace - move to previous input if current is empty
            if (event.key === 'Backspace' && !this.code[index] && index > 0) {
              this.$nextTick(() => {
                if (this.codeInputs[index - 1]) {
                  this.codeInputs[index - 1].focus();
                }
              });
            }

            // Arrow keys navigation
            if (event.key === 'ArrowLeft' && index > 0) {
              this.codeInputs[index - 1].focus();
            } else if (event.key === 'ArrowRight' && index < 5) {
              this.codeInputs[index + 1].focus();
            }
          },

          /**
           * Handle paste event - populate all fields from clipboard
           */
          handlePaste(event) {
            event.preventDefault();
            const pastedData = event.clipboardData.getData('text').trim();

            // Only process if it's 6 digits
            if (/^\d{6}$/.test(pastedData)) {
              this.code = pastedData.split('');
              this.$nextTick(() => {
                // Focus last input after paste
                if (this.codeInputs[5]) {
                  this.codeInputs[5].focus();
                }
              });
            }
          },

          async sendCode() {
            this.isVerifying = true;

            try {
              const response =
                this.accountType === "member"
                  ? await sendVerificationCodeApiMember(this.userEmail)
                  : await sendVerificationCodeApi(this.userEmail);

              if (!response?.success) {
                throw new Error(response?.message || "Failed to send verification code.");
              }

            } catch (error) {
              // ‚ùå error path (API error, network error, validation error)
              console.error("Verification error:", error);

              Swal.fire({
                icon: "error",
                title: "Error",
                text:
                  error.response?.data?.message ||
                  error.message ||
                  "An unexpected error occurred. Please try again.",
              });

            } finally {
              // üîÅ always runs
              this.isVerifying = false;
            }
          }
          ,
          /**
           * Resend verification code
           */
          async resendCode() {
            this.isResending = true;

            try {
              const response =
                this.accountType === "member"
                  ? await sendVerificationCodeApiMember(this.userEmail)
                  : await sendVerificationCodeApi(this.userEmail);

              if (!response?.success) {
                throw new Error(response?.message || "Failed to send verification code.");
              }

              // ‚úÖ success path
              Swal.fire({
                icon: "success",
                title: "Code Sent!",
                text: "A new verification code has been sent to your email.",
                timer: 2000,
                showConfirmButton: false,
              });

              // Clear current code and restart timer
              this.code = ["", "", "", "", "", ""];
              this.startTimer();

              // Focus first input
              this.$nextTick(() => {
                this.codeInputs[0]?.focus();
              });

            } catch (error) {
              // ‚ùå error path (API error, network error, unexpected error)
              console.error("Resend error:", error);

              Swal.fire({
                icon: "error",
                title: "Failed to Send Code",
                text:
                  error.response?.data?.message ||
                  error.message ||
                  "An unexpected error occurred. Please try again.",
              });

            } finally {
              // üîÅ always runs
              this.isResending = false;
            }
          }
          ,

          /**
           * Verify the entered code
           */
          async handleVerify() {
            if (!this.isCodeComplete) return;

            this.isVerifying = true;

            Swal.fire({
              title: "Verifying Code",
              text: "Please wait...",
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading();
              },
            });

            try {
              const response =
                this.accountType === "member"
                  ? await verifyEmailCodeApiMember({
                    email: this.userEmail,
                    code: this.fullCode.trim(),
                  })
                  : await verifyEmailCodeApi({
                    email: this.userEmail,
                    code: this.fullCode.trim(),
                  });

              if (!response?.success) {
                throw new Error(response?.message || "Verification failed.");
              }

              // ‚úÖ success path
              Swal.fire({
                icon: "success",
                title: "Email Verified!",
                text: "Your email has been successfully verified.",
                timer: 2000,
                showConfirmButton: false,
              });

              setTimeout(() => {
                window.location.href = "login.html";
              }, 2000);

            } catch (error) {
              // ‚ùå error path (API error, invalid code, network error)
              console.error("Verification error:", error);

              Swal.fire({
                icon: "error",
                title: "Verification Failed",
                text:
                  error.response?.data?.message ||
                  error.message ||
                  "An unexpected error occurred. Please try again.",
              });

              // Clear code for retry
              this.code = ["", "", "", "", "", ""];
              this.$nextTick(() => {
                this.codeInputs[0]?.focus();
              });

            } finally {
              // üîÅ always runs
              this.isVerifying = false;
              Swal.close(); // ensures loading always closes
            }
          },
        }
      }).mount('#app');
    </script>
  </body>

</html>